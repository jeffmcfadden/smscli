#!/bin/bash

# sms - Send and manage iMessages from the command line
# Usage: sms <recipient> <message>
#        sms --search <query>
#        sms --chats [query]
#        sms --list <name> [count]

# Resolve symlinks to get the actual script directory
SOURCE="$0"
while [ -L "$SOURCE" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

# Show help
show_help() {
    echo "Usage: sms <recipient> <message>"
    echo "       sms --search <query> [--limit N]"
    echo "       sms --chats [query] [--limit N]"
    echo "       sms --list <name> [--limit N]"
    echo ""
    echo "  recipient: phone number, email, contact name, or group chat name"
    echo "  message: the message to send"
    echo ""
    echo "Options:"
    echo "  --search, -s   Search contacts by partial name"
    echo "  --chats, -c    List named group chats (optional query to filter)"
    echo "  --list, -l     Show recent messages from a conversation (default: 10)"
    echo "  --limit, -n    Limit number of results returned"
    echo "  --help, -h     Show this help message"
}

# Handle --help
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

# Handle --chats option
if [ "$1" = "--chats" ] || [ "$1" = "-c" ]; then
    shift
    exec "$SCRIPT_DIR/list_chats.sh" "$@"
fi

# Handle --search option
if [ "$1" = "--search" ] || [ "$1" = "-s" ]; then
    shift
    if [ -z "$1" ]; then
        echo "Usage: sms --search <query> [--limit N]" >&2
        exit 1
    fi
    exec "$SCRIPT_DIR/search_contacts.sh" "$@"
fi

# Handle --list option
if [ "$1" = "--list" ] || [ "$1" = "-l" ]; then
    shift
    if [ -z "$1" ]; then
        echo "Usage: sms --list <name> [--limit N]" >&2
        exit 1
    fi
    exec "$SCRIPT_DIR/list_messages.sh" "$@"
fi

# Default: send a message
RECIPIENT="$1"
MESSAGE="$2"

if [ -z "$RECIPIENT" ] || [ -z "$MESSAGE" ]; then
    show_help
    exit 1
fi

# Try to resolve contact name to phone/email
RESOLVED=$("$SCRIPT_DIR/contact_lookup.sh" "$RECIPIENT" 2>/dev/null)

if [ -n "$RESOLVED" ]; then
    if [ "$RESOLVED" != "$RECIPIENT" ]; then
        echo "Found: $RESOLVED"
    fi
    RECIPIENT="$RESOLVED"
else
    # contact_lookup.sh returns empty if not found and not a phone/email
    # Check if it might be a group chat before giving up
    GROUP_CHECK=$(osascript -e "tell application \"Messages\" to try
        get name of (first chat whose name is \"$RECIPIENT\")
    on error
        return \"\"
    end try" 2>/dev/null)

    if [ -z "$GROUP_CHECK" ]; then
        echo "Error: Could not find contact or group chat '$RECIPIENT'" >&2
        exit 1
    fi
    echo "Found group chat: $RECIPIENT"
fi

# Send the message
"$SCRIPT_DIR/send_message.sh" "$RECIPIENT" "$MESSAGE"
RESULT=$?

if [ $RESULT -eq 0 ]; then
    echo "Message sent successfully to $RECIPIENT"
else
    echo "Failed to send message" >&2
fi

exit $RESULT
